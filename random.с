#include <stdio.h>
#include <stdlib.h>
#include <errno.h>
#include "random_source.h"
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

enum
{
    WR_SEED = 1,
    WR_MEM_ALLOC = 2,
    WR_FILE = 3,
    SIZE_TO_READ = 64 / 8,
};

double
next_ran(RandomSource *src)
{
    unsigned long long num = 0; 
    read(src->fd, &num, SIZE_TO_READ);
    return ((double) num) / (1 << 63);
}

RandomSource *
destroy_ran(RandomSource *src)
{
    free(src->op);
    free(src);
    return NULL;
}

RandomSource *
random_linear_factory(const char* params) {
    RandomSource *new = calloc(sizeof(*new), 1);
    RandomSourceOperations *op = calloc(sizeof(*op), 1);
    if (!new || !op) {
        fprintf(stderr, "In random.c: error with memory allocation\n");
        exit(WR_MEM_ALLOC);
    }
    int fd = open("/dev/urandom", O_RDONLY);
    if (fd == -1) {
        fprintf(stderr, "In random.c: Error with opening /dev/urandom!\n");
        exit(WR_FILE);
    }
    new->opt = op;
    new->opt->next = next_ran;
    new->opt->destroy = destroy_ran;
    return new;
}